@using WebMatcha.Services
@inject ServerSessionService ServerSession
@inject AuthService AuthService
@inject NavigationManager Navigation
@implements IAsyncDisposable

@if (isAuthenticated)
{
    <!-- Authenticated navigation -->
    <ul class="navbar-nav me-auto">
        <li class="nav-item">
            <NavLink class="nav-link" href="" Match="NavLinkMatch.All">
                <i class="bi bi-house-door-fill me-1"></i> Home
            </NavLink>
        </li>
        <li class="nav-item">
            <NavLink class="nav-link" href="browse">
                <i class="bi bi-search me-1"></i> Browse
            </NavLink>
        </li>
        <li class="nav-item">
            <NavLink class="nav-link" href="matches">
                <i class="bi bi-heart-fill me-1"></i> Matches
            </NavLink>
        </li>
        <li class="nav-item">
            <NavLink class="nav-link" href="chat">
                <i class="bi bi-chat-dots me-1"></i> Chat
            </NavLink>
        </li>
        <li class="nav-item">
            <NavLink class="nav-link" href="profile">
                <i class="bi bi-person-fill me-1"></i> Profile
            </NavLink>
        </li>
    </ul>
    
    <!-- Authenticated user actions -->
    <div class="d-flex align-items-center gap-3">
        <a href="/notifications" class="btn btn-outline-light">
            <i class="bi bi-bell"></i> 
            <span class="d-none d-md-inline">Notifications</span>
        </a>
        <div class="dropdown">
            <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-person-circle me-1"></i> 
                <span class="d-none d-md-inline">@currentUsername</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="/profile"><i class="bi bi-person me-2"></i>My Profile</a></li>
                <li><a class="dropdown-item" href="/settings"><i class="bi bi-gear me-2"></i>Settings</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><button class="dropdown-item text-danger" @onclick="HandleLogout">
                    <i class="bi bi-box-arrow-right me-2"></i>Logout
                </button></li>
            </ul>
        </div>
    </div>
}
else
{
    <!-- Unauthenticated navigation -->
    <ul class="navbar-nav me-auto">
        <li class="nav-item">
            <NavLink class="nav-link" href="" Match="NavLinkMatch.All">
                <i class="bi bi-house-door-fill me-1"></i> Home
            </NavLink>
        </li>
    </ul>
    
    <!-- Unauthenticated user actions -->
    <div class="d-flex align-items-center gap-2">
        <a href="/login" class="btn btn-outline-light">
            <i class="bi bi-box-arrow-in-right me-1"></i> Login
        </a>
        <a href="/register" class="btn btn-light">
            <i class="bi bi-person-plus me-1"></i> Sign Up
        </a>
    </div>
}

@code {
    private bool isAuthenticated = false;
    private string currentUsername = "";
    private Timer? refreshTimer;
    
    protected override async Task OnInitializedAsync()
    {
        await CheckAuthStatus();
        
        // Refresh auth status every 30 seconds
        refreshTimer = new Timer(async _ => await InvokeAsync(async () => 
        {
            await CheckAuthStatus();
            StateHasChanged();
        }), null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CheckAuthStatus();
            StateHasChanged();
        }
    }
    
    private async Task CheckAuthStatus()
    {
        try
        {
            isAuthenticated = await ServerSession.IsAuthenticatedAsync();
            if (isAuthenticated)
            {
                currentUsername = await ServerSession.GetCurrentUsernameAsync() ?? "User";
            }
        }
        catch (Exception)
        {
            isAuthenticated = false;
            currentUsername = "";
        }
    }
    
    private async Task HandleLogout()
    {
        try
        {
            var userId = await ServerSession.GetCurrentUserIdAsync();
            if (userId.HasValue)
            {
                await AuthService.LogoutAsync(userId.Value);
            }

            await ServerSession.ClearSessionAsync();

            isAuthenticated = false;
            currentUsername = "";

            Navigation.NavigateTo("/login");
        }
        catch (Exception)
        {
            // Handle logout error
            Navigation.NavigateTo("/login");
        }
    }
    
    public async ValueTask DisposeAsync()
    {
        refreshTimer?.Dispose();
    }
}